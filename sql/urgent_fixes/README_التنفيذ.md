# ๐ง ุชุนูููุงุช ุชูููุฐ ุฅุตูุงุญ Tenant ID

## โ๏ธ ููู ุฌุฏุงู - ุงูุฑุฃ ูุจู ุงูุชูููุฐ

ุชู ุงูุชุดุงู ุฃู:
1. โ **ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงุฑุบุฉ ุชูุงูุงู!**
2. โ ุฌููุน ุงูุฌุฏุงูู ุบูุฑ ููุฌูุฏุฉ (organizations, gl_accounts, ุฅูุฎ)
3. โ ูุฌุจ ุชูููุฐ ุงูุจููุฉ ุงููุงููุฉ ุฃููุงู

---

## ๐จ ุงูุญู ุงูุณุฑูุน

### ุงููุดููุฉ:
ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุง ุชุญุชูู ุนูู ุฃู ุฌุฏุงูู!

### ุงูุญู:
ูุฌุจ ุชูููุฐ ุงูุณูุฑูุจุช ุงูุฃุณุงุณู ุงููุงูู ุฃููุงู

---

## ๐ ุงูุฎุทูุงุช ุงูุตุญูุญุฉ ุจุงูุชุฑุชูุจ

### ุงูุฎุทูุฉ 0: ุนูู Backup (ุงุฎุชูุงุฑู - ุงููุงุนุฏุฉ ูุงุฑุบุฉ)

ุฅุฐุง ูุงูุช ููุงู ุจูุงูุงุช ูููุฉ:

1. ูู Supabase Dashboard
2. ุงุฐูุจ ุฅูู Settings > Database
3. ุงุถุบุท "Start a Backup"

---

### ุงูุฎุทูุฉ 1: ุฅูุดุงุก ุงูุจููุฉ ุงูุฃุณุงุณูุฉ ุงููุงููุฉ โญ **ุงูุฃูู**

**ููุฐ ุงูุณูุฑูุจุช:** `supabase-setup.sql` (ุงูููุฌูุฏ ูู ุงููุฌูุฏ ุงูุฑุฆูุณู)

```sql
-- ุงูุชุญ ููู: supabase-setup.sql ูู ุงููุฌูุฏ ุงูุฑุฆูุณู
-- ุงูุณุฎ ุงููุญุชูู ูุงููุงู (607 ุณุทุฑ)
-- ูุงูุตูู ูู Supabase SQL Editor
-- ุงุถุบุท Run
```

**ูุง ููุนูู:**
- โ ููุดุฆ ุฌููุน ุงูุฌุฏุงูู ุงูุฃุณุงุณูุฉ (30+ ุฌุฏูู)
- โ organizations, user_organizations
- โ gl_accounts (ุฏููู ุงูุญุณุงุจุงุช)
- โ products, warehouses, locations
- โ manufacturing_orders, stage_costs
- โ bom_headers, bom_lines
- โ stock_quants, stock_moves
- โ ุฌููุน ุงูุฌุฏุงูู ุงููุทููุจุฉ ูููุธุงู

**ุงูููุช ุงููุชููุน:** 2-3 ุฏูุงุฆู

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โ ุชู ุฅูุดุงุก ุฌููุน ุงูุฌุฏุงูู ุจูุฌุงุญ
โ ุชู ุชูุนูู RLS
โ ุชู ุฅูุดุงุก ุงูู Policies
```

---

### ุงูุฎุทูุฉ 2: ุงุณุชูุฑุงุฏ ุจูุงูุงุช ุฏููู ุงูุญุณุงุจุงุช

ุจุนุฏ ุฅูุดุงุก ุงูุฌุฏุงููุ ุชุญุชุงุฌ ูุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช:

**ุงูุฎูุงุฑ 1: ุงุณุชูุฑุงุฏ ูู ููู SQL ููุฌูุฏ**

ุงุจุญุซ ุนู ููู ูุญุชูู ุนูู ุจูุงูุงุช `gl_accounts`:
```sql
-- ุงุจุญุซ ุนู ูููุงุช ูุซู:
-- - wardah_coa_insert.sql
-- - insert_gl_accounts.sql
-- - initial_data.sql
```

**ุงูุฎูุงุฑ 2: ุฅูุดุงุก ููุธูุฉ ูุฏููุงู**

```sql
-- ุฅูุดุงุก ููุธูุฉ ุงูุชุฑุงุถูุฉ
INSERT INTO organizations (id, name, code, is_active)
VALUES (
  '00000000-0000-0000-0000-000000000001',
  'Wardah Factory',
  'WF-001',
  true
);
```

---

### ุงูุฎุทูุฉ 3: ุฑุจุท ุงููุณุชุฎุฏููู ุจุงูููุธูุฉ (ุฅู ูุฌุฏูุง)

**ููุฐ ุงูุณูุฑูุจุช:** `01_fix_tenant_id.sql`

```sql
-- ุงูุณุฎ ูุญุชูู sql/urgent_fixes/01_fix_tenant_id.sql
-- ูุงูุตูู ูู Supabase SQL Editor
```

**โ๏ธ ููุงุญุธุฉ:** ููุฐ ูุฐุง ููุท ุฅุฐุง ูุงูุช ูุฏูู ุจูุงูุงุช ููุฌูุฏุฉ ุชุญุชุงุฌ ุฅุตูุงุญ

**ูุง ููุนูู:**
1. โ ูุชุญูู ูู ูุฌูุฏ ููุธูุฉ ุงูุชุฑุงุถูุฉ (ููุดุฆูุง ุฅู ูู ุชูู ููุฌูุฏุฉ)
2. โ ูุฑุจุท ุฌููุน ุงูุณุฌูุงุช ุจู org_id ุงูุงูุชุฑุงุถู
3. โ ูุฑุจุท ุฌููุน ุงููุณุชุฎุฏููู ุจุงูููุธูุฉ
4. โ ูุญุฏุซ ุฌููุน ุงูุฌุฏุงูู (gl_accounts, manufacturing_orders, products, ุฅูุฎ)

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ     Summary Report - Wardah Factory     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ  GL Accounts: 190                        โ
โ  Manufacturing Orders: X                 โ
โ  Products: X                             โ
โ  Purchase Orders: X                      โ
โ  Sales Orders: X                         โ
โ  User Associations: X                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ุชู ุฅุตูุงุญ ูุดููุฉ Tenant ID ุจูุฌุงุญ!
โ ุฌููุน ุงูุจูุงูุงุช ูุฑุชุจุทุฉ ุจุงูููุธูุฉ ุงูุงูุชุฑุงุถูุฉ
โ ุฌููุน ุงููุณุชุฎุฏููู ูุฑุชุจุทูู ุจุงูููุธูุฉ
๐ ููููู ุงูุขู ุงุฎุชุจุงุฑ ุงููุธุงู
```

---

### ุงูุฎุทูุฉ 4: ุชูููุฐ Materialized Path (ูุญู Stack Depth)

**ููุฐ ุงูุณูุฑูุจุช:** `02_implement_materialized_path.sql`

```sql
-- ุงูุณุฎ ูุญุชูู sql/urgent_fixes/02_implement_materialized_path.sql
-- ูุงูุตูู ูู Supabase SQL Editor
```

**ูุง ููุนูู:**
- โ ููุนูู ltree extension
- โ ูุถูู ุนููุฏ path ูุฏููู ุงูุญุณุงุจุงุช
- โ ูููุฃ path ูุฌููุน ุงูุญุณุงุจุงุช
- โ ูุญู ูุดููุฉ Stack Depth

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ ุชู ุชุทุจูู Materialized Path ุจูุฌุงุญ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ  ุฅุฌูุงูู ุงูุญุณุงุจุงุช: 190                 โ
โ  ุงูุญุณุงุจุงุช ูุน path: 190                 โ
โ  ูุณุจุฉ ุงูุงูุชูุงู: 100%                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก ุงููุญุชููุฉ

### ุงูุฎุทุฃ: "relation does not exist"

**ุงูุณุจุจ:** ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงุฑุบุฉุ ูู ูุชู ุฅูุดุงุก ุงูุฌุฏุงูู ุจุนุฏ

**ุงูุญู:**
```sql
-- ุชุญูู ูู ุงูุฌุฏุงูู ุงูููุฌูุฏุฉ
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public'
ORDER BY table_name;

-- ุฅุฐุง ูุงูุช ุงููุชูุฌุฉ ูุงุฑุบุฉ ุฃู ูุง ุชุญุชูู ุนูู gl_accounts
-- ููุฐ supabase-setup.sql ุฃููุงู (ูู ุงููุฌูุฏ ุงูุฑุฆูุณู)
```

---

### ุงูุฎุทุฃ: "duplicate key value violates unique constraint"

**ุงูุณุจุจ:** ุงูููุธูุฉ ุฃู ุงูุจูุงูุงุช ููุฌูุฏุฉ ูุณุจูุงู

**ุงูุญู:**
```sql
-- ุชุญูู ูู ุงูููุธูุงุช ุงูููุฌูุฏุฉ
SELECT * FROM organizations;

-- ุฅุฐุง ูุฌุฏุช ููุธูุฉุ ุงุณุชุฎุฏู id ุงูููุฌูุฏ
-- ุจุฏูุงู ูู '00000000-0000-0000-0000-000000000001'
```

---

### ุงูุฎุทุฃ: "column does not exist"

**ุงูุณุจุจ:** ุงุณู ุงูุนููุฏ ูุฎุชูู

**ุงูุญู:**
```sql
-- ุชุญูู ูู ุฃุนูุฏุฉ gl_accounts
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'gl_accounts'
ORDER BY ordinal_position;

-- ุงุจุญุซ ุนู: org_id ุฃู tenant_id
```

---

### ุงูุฎุทุฃ: "null value violates constraint"

**ุงูุณุจุจ:** ุงูุจูุงูุงุช ุชุญุชูู ุนูู NULL

**ุงูุญู:**
```sql
-- ุชุญูู ูู ุงูููู NULL
SELECT 
  COUNT(*) FILTER (WHERE org_id IS NULL) as null_count,
  COUNT(*) as total
FROM gl_accounts;

-- ุฅุฐุง ูุฌุฏุช NULLุ ุงูุณูุฑูุจุช ุณูุตูุญูุง
```

---

### ุงูุฎุทุฃ: "ltree extension not available"

**ุงูุณุจุจ:** ltree ุบูุฑ ููุนูู

**ุงูุญู:**
```sql
-- ูุนูู ltree
CREATE EXTENSION IF NOT EXISTS ltree;

-- ุชุญูู
SELECT * FROM pg_extension WHERE extname = 'ltree';
```

---

## โ ุงูุชุญูู ูู ุงููุฌุงุญ

ุจุนุฏ ุชูููุฐ ุฌููุน ุงูุณูุฑูุจุชุงุชุ ููุฐ ูุฐุง:

```sql
-- 1. ุชุญูู ูู ุงูููุธูุฉ
SELECT * FROM organizations 
WHERE id = '00000000-0000-0000-0000-000000000001';

-- ูุฌุจ ุฃู ุชุฑู: Wardah Factory

-- 2. ุชุญูู ูู ุงูุญุณุงุจุงุช
SELECT 
  COUNT(*) as total_accounts,
  COUNT(*) FILTER (WHERE org_id IS NOT NULL) as with_org,
  COUNT(*) FILTER (WHERE path IS NOT NULL) as with_path
FROM gl_accounts;

-- ูุฌุจ ุฃู ูููู ุงููู ูุชุณุงูู: 190 = 190 = 190

-- 3. ุชุญูู ูู ุงููุณุชุฎุฏููู
SELECT 
  u.email,
  uo.role,
  o.name
FROM auth.users u
LEFT JOIN user_organizations uo ON u.id = uo.user_id
LEFT JOIN organizations o ON uo.org_id = o.id;

-- ูุฌุจ ุฃู ุชุฑู ุฌููุน ุงููุณุชุฎุฏููู ูุฑุชุจุทูู ุจู Wardah Factory
```

---

## ๐ฏ ุงูุฎูุงุตุฉ

**ุชุฑุชูุจ ุงูุชูููุฐ ุงูุตุญูุญ:**
1. โ Backup ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุงุฎุชูุงุฑู - ุงููุงุนุฏุฉ ูุงุฑุบุฉ)
2. โ `supabase-setup.sql` (ุงููุฌูุฏ ุงูุฑุฆูุณู) - **ุฅูุฒุงูู!**
3. โ๏ธ ุงุณุชูุฑุงุฏ ุจูุงูุงุช ุฏููู ุงูุญุณุงุจุงุช (ุฅู ูุฌุฏุช)
4. โ๏ธ `01_fix_tenant_id.sql` (ููุท ุฅุฐุง ูุงูุช ููุงู ุจูุงูุงุช ุชุญุชุงุฌ ุฅุตูุงุญ)
5. โ `02_implement_materialized_path.sql` (ูุญู Stack Depth)

**ุงูููุช ุงููุชููุน:** 10-15 ุฏูููุฉ

**ุงููุฎุงุทุฑ:** ููุฎูุถุฉ ุฌุฏุงู (ุงููุงุนุฏุฉ ูุงุฑุบุฉ)

---

## ๐ ุฅุฐุง ูุงุฌูุช ูุดุงูู

1. **ูุง ุชููู** ุฅุฐุง ุธูุฑุช ุฃุฎุทุงุก
2. **ุงุนูู ROLLBACK** ุฅุฐุง ูุงู ุงูุณูุฑูุจุช ูู transaction:
   ```sql
   ROLLBACK;
   ```
3. **ุฑุงุฌุน ุงูุฎุทุฃ** ูู Messages/Errors
4. **ุงุณุชุนุฏ Backup** ุฅุฐุง ูุฒู ุงูุฃูุฑ
5. **ุงุทูุจ ุงููุณุงุนุฏุฉ** ูุน ูุณุฎ ุฑุณุงูุฉ ุงูุฎุทุฃ ูุงููุฉ

---

**ุชู ุงูุชุญุฏูุซ:** 28 ุฃูุชูุจุฑ 2025  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุชูููุฐ

ุญุธุงู ููููุงู! ๐
