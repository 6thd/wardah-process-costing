<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 { color: #00d9ff; text-align: center; }
        .test { background: #16213e; border: 1px solid #0f3460; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .success { color: #4CAF50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        .data { background: #0f3460; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: 'Courier New', monospace; overflow-x: auto; }
        button { background: #00d9ff; color: #1a1a2e; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold; margin: 10px; }
        button:hover { background: #00b8d4; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #0f3460; }
        th { background: #0f3460; color: #00d9ff; }
        .info { background: #2196F3; color: white; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ”Œ Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>
    
    <div class="info">
        <strong>Ø§Ù„Ù‡Ø¯Ù:</strong> Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§ØªØµØ§Ù„ Supabase ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    </div>
    
    <div style="text-align: center;">
        <button onclick="testConnection()">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</button>
    </div>
    
    <div id="results"></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
        
        let supabase;
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒÙˆÙŠÙ† ÙˆØªÙ‡ÙŠØ¦Ø© Supabase
        async function initSupabase() {
            try {
                const response = await fetch('/config.json');
                const config = await response.json();
                
                console.log('ğŸ“¡ Config loaded:', {
                    url: config.SUPABASE_URL,
                    keyLength: config.SUPABASE_ANON_KEY?.length
                });
                
                supabase = createClient(config.SUPABASE_URL, config.SUPABASE_ANON_KEY);
                
                document.getElementById('results').innerHTML += `
                    <div class="test">
                        <h3 class="success">âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­</h3>
                        <div class="data">
                            <strong>URL:</strong> ${config.SUPABASE_URL}<br>
                            <strong>Key Length:</strong> ${config.SUPABASE_ANON_KEY?.length} Ø­Ø±Ù
                        </div>
                    </div>
                `;
                
                return true;
            } catch (error) {
                console.error('âŒ Failed to load config:', error);
                document.getElementById('results').innerHTML += `
                    <div class="test">
                        <h3 class="error">âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒÙˆÙŠÙ†</h3>
                        <div class="data">${error.message}</div>
                    </div>
                `;
                return false;
            }
        }
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
        window.testConnection = async function() {
            document.getElementById('results').innerHTML = '<div class="test"><h3>â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</h3></div>';
            
            // ØªÙ‡ÙŠØ¦Ø© Supabase Ø£ÙˆÙ„Ø§Ù‹
            const initialized = await initSupabase();
            if (!initialized) return;
            
            // Ø§Ø®ØªØ¨Ø§Ø± 1: Ù‚Ø±Ø§Ø¡Ø© Ø¬Ø¯ÙˆÙ„ gl_entries
            await testTable('gl_entries', 'ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©');
            
            // Ø§Ø®ØªØ¨Ø§Ø± 2: Ù‚Ø±Ø§Ø¡Ø© Ø¬Ø¯ÙˆÙ„ gl_entry_lines
            await testTable('gl_entry_lines', 'ğŸ“Š Ø¬Ø¯ÙˆÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯');
            
            // Ø§Ø®ØªØ¨Ø§Ø± 3: Ù‚Ø±Ø§Ø¡Ø© Ø¬Ø¯ÙˆÙ„ purchase_orders
            await testTable('purchase_orders', 'ğŸ›’ Ø¬Ø¯ÙˆÙ„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡');
            
            // Ø§Ø®ØªØ¨Ø§Ø± 4: Ù‚Ø±Ø§Ø¡Ø© Ø¬Ø¯ÙˆÙ„ sales_invoices
            await testTable('sales_invoices', 'ğŸ’° Ø¬Ø¯ÙˆÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');
            
            // Ø§Ø®ØªØ¨Ø§Ø± 5: Ø­Ø³Ø§Ø¨ Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
            await testTrialBalance();
        };
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ÙŠÙ†
        async function testTable(tableName, displayName) {
            try {
                const { data, error, count } = await supabase
                    .from(tableName)
                    .select('*', { count: 'exact' })
                    .limit(5);
                
                if (error) throw error;
                
                document.getElementById('results').innerHTML += `
                    <div class="test">
                        <h3 class="success">âœ… ${displayName}</h3>
                        <div class="data">
                            <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:</strong> ${count} Ø³Ø¬Ù„<br>
                            <strong>Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</strong>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    </div>
                `;
                
                console.log(`âœ… ${tableName}:`, { count, sample: data });
                
            } catch (error) {
                document.getElementById('results').innerHTML += `
                    <div class="test">
                        <h3 class="error">âŒ ${displayName}</h3>
                        <div class="data">
                            <strong>Ø§Ù„Ø®Ø·Ø£:</strong> ${error.message}<br>
                            <strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${error.details || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}<br>
                            <strong>Ø§Ù„Ø¥Ø´Ø§Ø±Ø©:</strong> ${error.hint || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
                        </div>
                    </div>
                `;
                
                console.error(`âŒ ${tableName}:`, error);
            }
        }
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø³Ø§Ø¨ Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        async function testTrialBalance() {
            try {
                console.log('ğŸ§® Ø¨Ø¯Ø¡ Ø­Ø³Ø§Ø¨ Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©...');
                
                // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© (case-insensitive)
                const { data: entries, error: entriesError } = await supabase
                    .from('gl_entries')
                    .select('id, entry_number, entry_date, status')
                    .ilike('status', 'posted')
                    .gte('entry_date', '2025-01-01')
                    .lte('entry_date', '2025-12-31');
                
                if (entriesError) throw entriesError;
                
                console.log(`âœ… ÙˆØ¬Ø¯Øª ${entries.length} Ù‚ÙŠØ¯ Ù…Ø¹ØªÙ…Ø¯`);
                
                if (entries.length === 0) {
                    document.getElementById('results').innerHTML += `
                        <div class="test">
                            <h3 class="warning">âš ï¸ Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3>
                            <div class="data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</div>
                        </div>
                    `;
                    return;
                }
                
                // 2. Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                const entryIds = entries.map(e => e.id);
                const { data: lines, error: linesError } = await supabase
                    .from('gl_entry_lines')
                    .select('*')
                    .in('entry_id', entryIds);
                
                if (linesError) throw linesError;
                
                console.log(`âœ… ÙˆØ¬Ø¯Øª ${lines.length} Ø³Ø·Ø± ØªÙØµÙŠÙ„ÙŠ`);
                
                // 3. ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨
                const accountTotals = new Map();
                
                lines.forEach(line => {
                    if (!accountTotals.has(line.account_code)) {
                        accountTotals.set(line.account_code, {
                            account_code: line.account_code,
                            account_name: line.account_name,
                            debit: 0,
                            credit: 0
                        });
                    }
                    
                    const account = accountTotals.get(line.account_code);
                    account.debit += parseFloat(line.debit_amount || 0);
                    account.credit += parseFloat(line.credit_amount || 0);
                });
                
                const trialBalance = Array.from(accountTotals.values())
                    .sort((a, b) => a.account_code.localeCompare(b.account_code));
                
                const totalDebit = trialBalance.reduce((sum, acc) => sum + acc.debit, 0);
                const totalCredit = trialBalance.reduce((sum, acc) => sum + acc.credit, 0);
                const balanced = Math.abs(totalDebit - totalCredit) < 0.01;
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>Ø±Ù…Ø² Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                                <th>Ù…Ø¯ÙŠÙ†</th>
                                <th>Ø¯Ø§Ø¦Ù†</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                trialBalance.forEach(acc => {
                    tableHtml += `
                        <tr>
                            <td>${acc.account_code}</td>
                            <td>${acc.account_name}</td>
                            <td>${acc.debit.toFixed(2)}</td>
                            <td>${acc.credit.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #0f3460; font-weight: bold;">
                                <td colspan="2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                                <td>${totalDebit.toFixed(2)}</td>
                                <td>${totalCredit.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
                
                document.getElementById('results').innerHTML += `
                    <div class="test">
                        <h3 class="${balanced ? 'success' : 'error'}">
                            ${balanced ? 'âœ…' : 'âŒ'} Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                        </h3>
                        <div class="data">
                            <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:</strong> ${trialBalance.length}<br>
                            <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†:</strong> ${totalDebit.toFixed(2)} Ø±.Ø³<br>
                            <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†:</strong> ${totalCredit.toFixed(2)} Ø±.Ø³<br>
                            <strong>Ø§Ù„ÙØ±Ù‚:</strong> ${(totalDebit - totalCredit).toFixed(2)} Ø±.Ø³<br>
                            <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${balanced ? 'âœ… Ù…ØªÙˆØ§Ø²Ù†' : 'âŒ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†'}
                        </div>
                        ${tableHtml}
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('results').innerHTML += `
                    <div class="test">
                        <h3 class="error">âŒ ÙØ´Ù„ Ø­Ø³Ø§Ø¨ Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3>
                        <div class="data">
                            <strong>Ø§Ù„Ø®Ø·Ø£:</strong> ${error.message}<br>
                            <strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${error.details || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}<br>
                            <strong>Ø§Ù„Ø¥Ø´Ø§Ø±Ø©:</strong> ${error.hint || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
                        </div>
                    </div>
                `;
                
                console.error('âŒ Trial balance error:', error);
            }
        }
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', () => {
            console.log('ğŸš€ Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø© - ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        });
    </script>
</body>
</html>
