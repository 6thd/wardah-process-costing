# âš¡ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø³Ø±ÙŠØ¹ - Ø®Ø·ÙˆØ§Øª Ø¹Ù…Ù„ÙŠØ© ÙÙˆØ±ÙŠØ©

**Ù„Ù„Ø¨Ø¯Ø¡ ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ù†Ø¸Ø§Ù… ÙˆØ±Ø¯Ø© ERP**

---

## ğŸ¯ Ø§Ù„Ù‡Ø¯Ù
Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø±Ø¬Ø© ÙÙŠ **3-5 Ø£ÙŠØ§Ù…** Ù„Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….

---

## ğŸ“‹ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡ (15 Ø¯Ù‚ÙŠÙ‚Ø©)

### 1. Ø¹Ù…Ù„ Backup ÙƒØ§Ù…Ù„
```bash
# Ù…Ù† Supabase Dashboard:
# Project Settings > Database > Database Backups > Manual Backup
```

### 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
```bash
# ØªØ­Ù‚Ù‚ Ù…Ù† Node.js
node --version  # ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 18+

# ØªØ­Ù‚Ù‚ Ù…Ù† npm
npm --version  # ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 9+

# ØªØ­Ù‚Ù‚ Ù…Ù† git
git --version
```

### 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase
```bash
# Ø§ÙØªØ­ config.json ÙˆØªØ­Ù‚Ù‚ Ù…Ù†:
# - SUPABASE_URL
# - SUPABASE_ANON_KEY
# - SUPABASE_SERVICE_KEY
```

---

## ğŸ”´ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„: Ø¥ØµÙ„Ø§Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

### Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥ØµÙ„Ø§Ø­ Tenant ID (90 Ø¯Ù‚ÙŠÙ‚Ø©)

#### 1.1 ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
Ø§ÙØªØ­ Supabase SQL Editor ÙˆØ´ØºÙ„:

```sql
-- ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
SELECT 
  'Total Accounts' as metric,
  COUNT(*) as count
FROM gl_accounts
UNION ALL
SELECT 
  'Accounts with NULL tenant_id',
  COUNT(*)
FROM gl_accounts
WHERE tenant_id IS NULL
UNION ALL
SELECT 
  'Unique tenant_ids',
  COUNT(DISTINCT tenant_id)
FROM gl_accounts
WHERE tenant_id IS NOT NULL;

-- ÙØ­Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…Ù†Ø¸Ù…Ø§Øª
SELECT 
  'Total Users' as metric,
  COUNT(*) as count
FROM auth.users
UNION ALL
SELECT 
  'Users with Organization',
  COUNT(DISTINCT user_id)
FROM user_organizations;
```

#### 1.2 ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­
Ø´ØºÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª **Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·**:

```sql
-- ===================================
-- Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Tenant ID
-- ===================================

BEGIN;

-- 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø¸Ù…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
INSERT INTO organizations (
  id,
  name,
  name_ar,
  code,
  is_active,
  created_at,
  updated_at
)
VALUES (
  '00000000-0000-0000-0000-000000000001',
  'Wardah Factory',
  'Ù…ØµÙ†Ø¹ ÙˆØ±Ø¯Ø©',
  'WF-001',
  true,
  NOW(),
  NOW()
)
ON CONFLICT (id) DO UPDATE
SET 
  name = EXCLUDED.name,
  name_ar = EXCLUDED.name_ar,
  is_active = true,
  updated_at = NOW();

-- 2. ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªÙŠ tenant_id ÙÙŠÙ‡Ø§ NULL
UPDATE gl_accounts
SET 
  tenant_id = '00000000-0000-0000-0000-000000000001',
  updated_at = NOW()
WHERE tenant_id IS NULL;

-- 3. Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø§Ù„Ù…Ù†Ø¸Ù…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
INSERT INTO user_organizations (user_id, org_id, role, created_at, updated_at)
SELECT 
  u.id,
  '00000000-0000-0000-0000-000000000001'::UUID,
  'admin',
  NOW(),
  NOW()
FROM auth.users u
ON CONFLICT (user_id, org_id) 
DO UPDATE SET 
  role = 'admin',
  updated_at = NOW();

-- 4. Ø¥Ø¶Ø§ÙØ© NOT NULL constraint Ø¹Ù„Ù‰ tenant_id
ALTER TABLE gl_accounts
ALTER COLUMN tenant_id SET NOT NULL;

-- 5. Ø¥Ø¶Ø§ÙØ© default value
ALTER TABLE gl_accounts
ALTER COLUMN tenant_id 
SET DEFAULT '00000000-0000-0000-0000-000000000001'::UUID;

COMMIT;

-- ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
SELECT 
  'After Fix: Total Accounts' as status,
  COUNT(*) as count
FROM gl_accounts
UNION ALL
SELECT 
  'After Fix: NULL tenant_id',
  COUNT(*)
FROM gl_accounts
WHERE tenant_id IS NULL;
```

#### 1.3 Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­
```sql
-- ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø©:
-- After Fix: Total Accounts | ~190
-- After Fix: NULL tenant_id  | 0

-- ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
SELECT 
  u.email,
  uo.org_id,
  o.name as org_name,
  uo.role
FROM auth.users u
JOIN user_organizations uo ON u.id = uo.user_id
JOIN organizations o ON uo.org_id = o.id;
```

âœ… **Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­:** Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ø¨Ù€ tenant_id = NULL

---

### Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ¨Ø³ÙŠØ· RLS Policies (60 Ø¯Ù‚ÙŠÙ‚Ø©)

#### 2.1 Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©
```sql
-- Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¹Ù„Ù‰ gl_accounts
DROP POLICY IF EXISTS "Users can view accounts in their organization" ON gl_accounts;
DROP POLICY IF EXISTS "Users can insert accounts" ON gl_accounts;
DROP POLICY IF EXISTS "Users can update accounts" ON gl_accounts;
DROP POLICY IF EXISTS "Users can delete accounts" ON gl_accounts;
-- Ø£Ø¶Ù Ø£ÙŠ Ø³ÙŠØ§Ø³Ø§Øª Ø£Ø®Ø±Ù‰ ØªØ¹Ø±ÙÙ‡Ø§
```

#### 2.2 Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙŠØ§Ø³Ø§Øª Ø¨Ø³ÙŠØ·Ø© ÙˆÙˆØ§Ø¶Ø­Ø©
```sql
-- ===================================
-- Ø³ÙŠØ§Ø³Ø§Øª RLS Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù„Ù€ gl_accounts
-- ===================================

-- Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© (Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù†Ø¸Ù…ØªÙ‡Ù…)
CREATE POLICY "select_gl_accounts_policy"
ON gl_accounts
FOR SELECT
USING (
  tenant_id IN (
    SELECT org_id 
    FROM user_organizations 
    WHERE user_id = auth.uid()
  )
);

-- Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© (admin Ùˆ accountant ÙÙ‚Ø·)
CREATE POLICY "insert_gl_accounts_policy"
ON gl_accounts
FOR INSERT
WITH CHECK (
  tenant_id IN (
    SELECT org_id 
    FROM user_organizations 
    WHERE user_id = auth.uid()
    AND role IN ('admin', 'accountant')
  )
);

-- Ø³ÙŠØ§Ø³Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« (admin Ùˆ accountant ÙÙ‚Ø·)
CREATE POLICY "update_gl_accounts_policy"
ON gl_accounts
FOR UPDATE
USING (
  tenant_id IN (
    SELECT org_id 
    FROM user_organizations 
    WHERE user_id = auth.uid()
    AND role IN ('admin', 'accountant')
  )
);

-- Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø­Ø°Ù (admin ÙÙ‚Ø·)
CREATE POLICY "delete_gl_accounts_policy"
ON gl_accounts
FOR DELETE
USING (
  tenant_id IN (
    SELECT org_id 
    FROM user_organizations 
    WHERE user_id = auth.uid()
    AND role = 'admin'
  )
);

-- ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ RLS
ALTER TABLE gl_accounts ENABLE ROW LEVEL SECURITY;
```

#### 2.3 ØªØ·Ø¨ÙŠÙ‚ Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø¹Ù„Ù‰ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
```sql
-- ÙƒØ±Ø± Ù†ÙØ³ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ù„Ø¬Ø¯Ø§ÙˆÙ„:
-- - manufacturing_orders
-- - purchase_orders
-- - sales_orders
-- - inventory items
-- Ø¥Ù„Ø®...
```

âœ… **Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­:** ÙŠÙ…ÙƒÙ†Ùƒ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ Dashboard

---

### Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ·Ø¨ÙŠÙ‚ Materialized Path (120 Ø¯Ù‚ÙŠÙ‚Ø©)

#### 3.1 ØªÙØ¹ÙŠÙ„ ltree extension
```sql
CREATE EXTENSION IF NOT EXISTS ltree;
```

#### 3.2 Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ path
```sql
-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙˆØ¯
ALTER TABLE gl_accounts 
ADD COLUMN IF NOT EXISTS path ltree;

-- Ø¥Ù†Ø´Ø§Ø¡ index Ù„Ù„Ø£Ø¯Ø§Ø¡
CREATE INDEX IF NOT EXISTS idx_gl_accounts_path 
ON gl_accounts USING GIST (path);

-- Ø¥Ù†Ø´Ø§Ø¡ index Ø¥Ø¶Ø§ÙÙŠ
CREATE INDEX IF NOT EXISTS idx_gl_accounts_parent_code 
ON gl_accounts (parent_code);
```

#### 3.3 Ø¥Ù†Ø´Ø§Ø¡ function Ù„Ø­Ø³Ø§Ø¨ path
```sql
CREATE OR REPLACE FUNCTION calculate_account_path(account_code TEXT)
RETURNS ltree
LANGUAGE plpgsql
AS $$
DECLARE
  parent_path ltree;
  current_parent_code TEXT;
  path_result TEXT;
BEGIN
  -- Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ù‡ parentØŒ path = code Ù†ÙØ³Ù‡
  SELECT parent_code INTO current_parent_code
  FROM gl_accounts
  WHERE code = account_code;
  
  IF current_parent_code IS NULL OR current_parent_code = '' THEN
    RETURN account_code::ltree;
  END IF;
  
  -- Ø§Ø­Ø³Ø¨ path Ø§Ù„Ù€ parent Ø¨Ø´ÙƒÙ„ recursive
  SELECT path INTO parent_path
  FROM gl_accounts
  WHERE code = current_parent_code;
  
  -- Ø¥Ø°Ø§ Ø§Ù„Ù€ parent Ù…Ø§ Ø¹Ù†Ø¯Ù‡ pathØŒ Ø§Ø­Ø³Ø¨Ù‡
  IF parent_path IS NULL THEN
    parent_path := calculate_account_path(current_parent_code);
    UPDATE gl_accounts 
    SET path = parent_path 
    WHERE code = current_parent_code;
  END IF;
  
  -- path = parent_path + current_code
  RETURN (parent_path::text || '.' || account_code)::ltree;
END;
$$;
```

#### 3.4 ØªØ¹Ø¨Ø¦Ø© path Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
```sql
-- ØªØ¹Ø¨Ø¦Ø© path Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªÙŠ Ù„ÙŠØ³ Ù„Ù‡Ø§ parent
UPDATE gl_accounts
SET path = code::ltree
WHERE (parent_code IS NULL OR parent_code = '')
AND path IS NULL;

-- ØªØ¹Ø¨Ø¦Ø© path Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¨Ø§Ù‚ÙŠØ© (Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Ø¹Ø¯Ø© Ù…Ø±Ø§Øª)
DO $$
DECLARE
  updated_count INTEGER;
BEGIN
  LOOP
    UPDATE gl_accounts a
    SET path = (p.path::text || '.' || a.code)::ltree
    FROM gl_accounts p
    WHERE a.parent_code = p.code
    AND p.path IS NOT NULL
    AND a.path IS NULL;
    
    GET DIAGNOSTICS updated_count = ROW_COUNT;
    EXIT WHEN updated_count = 0;
  END LOOP;
END $$;

-- ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø©
SELECT 
  COUNT(*) FILTER (WHERE path IS NOT NULL) as with_path,
  COUNT(*) FILTER (WHERE path IS NULL) as without_path,
  COUNT(*) as total
FROM gl_accounts;
```

#### 3.5 Ø¥Ù†Ø´Ø§Ø¡ trigger Ù„ØªØ­Ø¯ÙŠØ« path ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
```sql
CREATE OR REPLACE FUNCTION update_account_path()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
  -- Ø­Ø³Ø§Ø¨ path Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯/Ø§Ù„Ù…Ø­Ø¯Ø«
  NEW.path := calculate_account_path(NEW.code);
  
  -- ØªØ­Ø¯ÙŠØ« path Ù„Ù„Ø£Ø¨Ù†Ø§Ø¡ Ø¥Ø°Ø§ ØªØºÙŠØ± parent_code
  IF TG_OP = 'UPDATE' AND OLD.code <> NEW.code THEN
    UPDATE gl_accounts
    SET path = calculate_account_path(code)
    WHERE parent_code = NEW.code;
  END IF;
  
  RETURN NEW;
END;
$$;

-- Ø¥Ù†Ø´Ø§Ø¡ trigger
DROP TRIGGER IF EXISTS trg_update_account_path ON gl_accounts;
CREATE TRIGGER trg_update_account_path
BEFORE INSERT OR UPDATE OF code, parent_code
ON gl_accounts
FOR EACH ROW
EXECUTE FUNCTION update_account_path();
```

âœ… **Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­:** Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù‡Ø§ path

---

### Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (30 Ø¯Ù‚ÙŠÙ‚Ø©)

```bash
# ÙÙŠ Terminal
npm run dev
```

Ø§ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù„Ù‰ `http://localhost:5173` ÙˆØªØ­Ù‚Ù‚ Ù…Ù†:

1. âœ… Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙŠØ¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (190 Ø­Ø³Ø§Ø¨)
2. âœ… Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù‡Ø±Ù…ÙŠØ© ØµØ­ÙŠØ­Ø©
3. âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Console
4. âœ… ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨

---

## ğŸŸ¡ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ø£Ù…Ø§Ù†

### Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ù†Ø´Ø§Ø¡ Auth Context (60 Ø¯Ù‚ÙŠÙ‚Ø©)

#### 1.1 Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù
```bash
mkdir -p src/contexts
```

#### 1.2 Ø¥Ù†Ø´Ø§Ø¡ AuthContext.tsx
```typescript
// src/contexts/AuthContext.tsx
import { createContext, useContext, useEffect, useState, ReactNode } from 'react';
import { User, Session } from '@supabase/supabase-js';
import { getSupabase } from '@/lib/supabase';

interface AuthContextType {
  user: User | null;
  session: Session | null;
  loading: boolean;
  signOut: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    const supabase = getSupabase();
    
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setUser(session?.user ?? null);
      setLoading(false);
    });
    
    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (_event, session) => {
        setSession(session);
        setUser(session?.user ?? null);
        setLoading(false);
      }
    );
    
    return () => subscription.unsubscribe();
  }, []);
  
  const signOut = async () => {
    const supabase = getSupabase();
    await supabase.auth.signOut();
  };
  
  return (
    <AuthContext.Provider value={{ user, session, loading, signOut }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return context;
}
```

#### 1.3 ØªØ­Ø¯ÙŠØ« App.tsx
```typescript
// src/App.tsx
import { AuthProvider } from '@/contexts/AuthContext';

function App() {
  return (
    <AuthProvider>
      <QueryClientProvider client={queryClient}>
        {/* ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ */}
      </QueryClientProvider>
    </AuthProvider>
  );
}
```

---

### Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ù†Ø´Ø§Ø¡ Protected Route (45 Ø¯Ù‚ÙŠÙ‚Ø©)

#### 2.1 Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯
```bash
mkdir -p src/components/auth
```

#### 2.2 Ø¥Ù†Ø´Ø§Ø¡ ProtectedRoute.tsx
```typescript
// src/components/auth/ProtectedRoute.tsx
import { Navigate, Outlet } from 'react-router-dom';
import { useAuth } from '@/contexts/AuthContext';

export function ProtectedRoute() {
  const { user, loading } = useAuth();
  
  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
          <p className="mt-4 text-muted-foreground">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
      </div>
    );
  }
  
  if (!user) {
    return <Navigate to="/login" replace />;
  }
  
  return <Outlet />;
}
```

#### 2.3 Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© Login Ø¨Ø³ÙŠØ·Ø©
```typescript
// src/pages/login.tsx
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { getSupabase } from '@/lib/supabase';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

export function LoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const navigate = useNavigate();
  
  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    
    try {
      const supabase = getSupabase();
      const { error } = await supabase.auth.signInWithPassword({
        email,
        password
      });
      
      if (error) throw error;
      
      navigate('/dashboard');
    } catch (err: any) {
      setError(err.message || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="flex items-center justify-center min-h-screen bg-background">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle className="text-2xl text-center">
            Ù†Ø¸Ø§Ù… ÙˆØ±Ø¯Ø© ERP
          </CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleLogin} className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-2">
                Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
              </label>
              <Input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="admin@wardah.sa"
                required
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium mb-2">
                ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
              </label>
              <Input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
              />
            </div>
            
            {error && (
              <div className="p-3 bg-destructive/10 text-destructive rounded-md text-sm">
                {error}
              </div>
            )}
            
            <Button 
              type="submit" 
              className="w-full" 
              disabled={loading}
            >
              {loading ? 'Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'}
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
```

#### 2.4 ØªØ­Ø¯ÙŠØ« Routes
```typescript
// src/pages/routes.tsx
import { ProtectedRoute } from '@/components/auth/ProtectedRoute';
import { LoginPage } from '@/pages/login';

export const appRouter = createBrowserRouter([
  {
    path: "/login",
    element: <LoginPage />
  },
  {
    path: "/",
    element: <ProtectedRoute />,  // ğŸ”’ Ù…Ø­Ù…ÙŠ
    children: [
      {
        element: <AppLayout />,
        children: [
          {
            index: true,
            element: <Navigate to="/dashboard" replace />,
          },
          {
            path: "dashboard/*",
            element: <DashboardModule />,
          },
          // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
        ]
      }
    ]
  }
]);
```

---

### Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (15 Ø¯Ù‚ÙŠÙ‚Ø©)

1. **Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„:**
   - Ø§ÙØªØ­ `http://localhost:5173`
   - ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ÙˆÙ„Ùƒ Ù„ØµÙØ­Ø© Login

2. **Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:**
   - Ø§Ø³ØªØ®Ø¯Ù…: `admin@wardah.sa` / `admin123`
   - ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¯Ø®Ù„Ùƒ Ù„Ù„Ù€ Dashboard

3. **Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:**
   - ÙÙŠ Ø§Ù„Ù€ HeaderØŒ Ø§Ø¶ØºØ· Logout
   - ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ®Ø±Ø¬Ùƒ Ù„ØµÙØ­Ø© Login

âœ… **Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­:** Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„

---

## ğŸ”µ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø«Ø§Ù„Ø«: ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡

### Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ø³ÙŠÙ† React Query (30 Ø¯Ù‚ÙŠÙ‚Ø©)

```typescript
// src/App.tsx - ØªØ­Ø¯ÙŠØ« QueryClient config
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000,      // 5 Ø¯Ù‚Ø§Ø¦Ù‚
      cacheTime: 10 * 60 * 1000,     // 10 Ø¯Ù‚Ø§Ø¦Ù‚
      refetchOnWindowFocus: false,
      refetchOnReconnect: false,
      retry: 1
    }
  }
});
```

---

### Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥ØµÙ„Ø§Ø­ Realtime Subscriptions (60 Ø¯Ù‚ÙŠÙ‚Ø©)

Ø¥Ù†Ø´Ø§Ø¡ custom hook:

```typescript
// src/hooks/useRealtimeSubscription.ts
import { useEffect, useRef } from 'react';
import { getSupabase } from '@/lib/supabase';
import { RealtimeChannel } from '@supabase/supabase-js';

export function useRealtimeSubscription(
  table: string,
  callback: (payload: any) => void
) {
  const channelRef = useRef<RealtimeChannel | null>(null);
  
  useEffect(() => {
    const supabase = getSupabase();
    
    // Create channel
    channelRef.current = supabase
      .channel(`${table}_changes`)
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table },
        callback
      )
      .subscribe();
    
    // Cleanup
    return () => {
      if (channelRef.current) {
        channelRef.current.unsubscribe();
      }
    };
  }, [table, callback]);
}

// Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ component:
// useRealtimeSubscription('manufacturing_orders', (payload) => {
//   queryClient.invalidateQueries(['manufacturing-orders']);
// });
```

---

## ğŸ“Š Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (30 Ø¯Ù‚ÙŠÙ‚Ø©)

### Checklist
- [ ] Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙŠØ¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
- [ ] Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Stack Depth
- [ ] Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø±Ø¨ÙˆØ·ÙˆÙ† Ø¨Ù…Ù†Ø¸Ù…Ø§Øª
- [ ] RLS ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
- [ ] Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„
- [ ] Session ØªØ¨Ù‚Ù‰ Ù†Ø´Ø·Ø©
- [ ] Logout ÙŠØ¹Ù…Ù„
- [ ] Ù„Ø§ ØªÙˆØ¬Ø¯ warnings ÙÙŠ Console
- [ ] `npm run build` ÙŠÙ†Ø¬Ø­
- [ ] Ø§Ù„ØµÙØ­Ø§Øª ØªØ­Ù…Ù„ Ø¨Ø³Ø±Ø¹Ø©

---

## ğŸ‰ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©

Ø¨Ø¹Ø¯ 3 Ø£ÙŠØ§Ù…:
- âœ… Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø©
- âœ… Ø¯Ù„ÙŠÙ„ Ø­Ø³Ø§Ø¨Ø§Øª ÙƒØ§Ù…Ù„ ÙˆØ³Ø±ÙŠØ¹
- âœ… Ù…ØµØ§Ø¯Ù‚Ø© Ø¢Ù…Ù†Ø©
- âœ… Ø£Ø¯Ø§Ø¡ Ù…Ø­Ø³Ù†

---

## ğŸ“ Ø¥Ø°Ø§ ÙˆØ§Ø¬Ù‡ØªÙƒ Ù…Ø´ÙƒÙ„Ø©

### Ù…Ø´ÙƒÙ„Ø©: "Stack depth limit exceeded"
**Ø§Ù„Ø­Ù„:** ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø®Ø·ÙˆØ§Øª Materialized Path

### Ù…Ø´ÙƒÙ„Ø©: "Ù„Ø§ Ø£Ø±Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
**Ø§Ù„Ø­Ù„:** ØªØ­Ù‚Ù‚ Ù…Ù† tenant_id Ùˆ user_organizations

### Ù…Ø´ÙƒÙ„Ø©: "Build fails"
**Ø§Ù„Ø­Ù„:** `rm -rf node_modules && npm install`

---

**Ø­Ø¸Ø§Ù‹ Ù…ÙˆÙÙ‚Ø§Ù‹!** ğŸš€
