# HR × Hasebny Migration Blueprint

> الهدف: مواءمة وحدة الموارد البشرية في **Wardah ERP** مع المنطق التشغيلي
> لنظام **«حاسبني»** (موظفون → حضور → إجازات → رواتب + خدمات ذكية).

## 1. نظرة عامة

| عنصر | وضع Wardah الحالي | المطلوب حسب «حاسبني» | حالة التنفيذ |
|------|-------------------|------------------------|---------------|
| بيانات الموظفين | جدول `employees` تقليدي | كائن مركّب (عقد، رواتب، حالة أرشفة) | Gap |
| الحضور | جدول مسطّح `attendance_records` | خريطة days.{day} لكل شهر | ✅ `hr_attendance_monthly` تمت إضافتها في `17_hr` |
| الإجازات | `employee_leaves` فقط | تكامل تلقائي مع الحضور | Gap |
| الرواتب | `payroll_runs` + `payroll_details` | محرك شهري يعتمد على الحضور وإقفال الشهر | جزئي (تم تجهيز `hr_payroll_locks`) |
| التنبيهات الذكية | جداول جديدة (16_hr) | منطق تحليل دوري | Gap |
| التحليل التنبؤي | غير موجود | Gemini/LLM summaries | Gap |
| سياسات العمل | غير موجود | جدول إعدادات (ساعات، ورديات، Overtime) | ✅ `hr_policies` تمت إضافتها |

## 2. متطلبات البيانات

### 2.1 الموظفون (workers)
- إضافة حقول داخل `employees` أو جدول ملازم:
  - `contract_start`, `contract_end`, `shift_type` (day/night), `status` (`active`, `archived`).
  - كائن `salary_components` (basic, housing, transport) أو جدول `hr_salary_components`.
  - منطق `archiveEmployee` = تحديث حالة دون حذف.

### 2.2 الحضور (attendance_{yyyy_mm})
- تم اعتماد جدول `hr_attendance_monthly` (JSONB) + دالة `upsert_attendance_day` داخل `sql/hr/17_hr_core_extensions.sql`.
- واجهات الخدمة (`attendance-service.ts`) ستوفّر:
  - `getMonthlyAttendance`, `setDayStatus`, `listAttendanceForPeriod`.
  - التحقق من قفل الشهر عبر `hr_payroll_locks`.

### 2.3 الإجازات
- ربط `employee_leaves` مع الحضور:
  - عند الموافقة: loop على `start_date..end_date` واستدعاء `setDayStatus` بحالة `annual_leave` أو `sick_leave`.
  - إضافة حقل `source='leave-request'` في سجلات الحضور لتتبع المصدر.

- ### 2.4 الرواتب وإقفال الشهر
- تم بناء خدمة `payroll-engine.ts` التي:
  - تجمع الموظفين النشطين، مكونات الرواتب، الحضور الشهري وسياسات العمل.
  - تحسب الغياب والعمل الإضافي وتنتج صافي الراتب لكل موظف.
  - تستدعي `processPayrollRun` لإقفال الشهر، إنشاء سجل في `payroll_runs`, تحديث `hr_payroll_locks` وإصدار قيد محاسبي عبر `gl_entries`.
- واجهة تبويب الرواتب أصبحت تعرض اختيار الشهر، المعاينة، ثم زر الإقفال الذي يعتمد على `hr_payroll_account_mappings` لتوزيع القيد على حسابات المصروفات والالتزامات.

## 3. الخدمات الذكية

### 3.1 Smart Alerts Service
- تشغيل يومي (cron / scheduled job):
  - عقود توشك على الانتهاء (<30 يوم).
  - موظفون تجاوزوا حدّ الغياب.
  - رواتب بصافي صفر/سالب.
- تكتب النتائج في `hr_alerts` (تم إنشاؤه في 16_hr) مع `severity`.

### 3.2 AI Predictive Insights
- خدمة `aiInsights.generate(employeeId)`:
  1. تجمع آخر 6–12 كشف راتب.
  2. تحلل الاتجاهات (صافي الدفع، ساعات إضافية، خصومات).
  3. تستدعي Gemini/LLM لإرجاع ملخص بالعربية + توصيات.
- يتم عرض الملخص في لوحة HR (تبويب التحليلات).

## 4. سياسات العمل (`hr_policies`)

| سياسة | القيمة الافتراضية | ملاحظات |
|-------|-------------------|---------|
| ساعات الموظفين | 8h لكل وردية | فئة “موظف” فقط |
| ساعات العمال | 11h لكل وردية | يوجد ورديتان (صباحية/مسائية) |
| عدد الورديات | 2 | يمكن تعديلها لاحقاً |
| يوم العطلة الأسبوعية | الجمعة | فقط |
| معامل العمل الإضافي | 1.5× | للجميع وفق مكتب العمل |
| عطلات رسمية | فارغ حالياً | placeholder |

> سيتم إنشاء جدول `hr_policies` مع واجهة إعدادات تمكن الإدارة من تعديل هذه القيم لاحقاً.

## 5. خارطة الطريق التنفيذية

1. **تحليل تفصيلي** للفجوات (الملف الحالي).
2. **تصميم الخدمات**:
   - Employees Service (CRUD + Archive)
   - Attendance Service (monthly map)
   - Leave Service (auto sync)
   - Payroll Engine
   - Alerts Scheduler
   - AI Insight Service
   - Policies Store
3. **تنفيذ تدريجي**:
   - قاعدة البيانات (جداول/JSONB/فهارس/RLS).
   - خدمات Supabase/TS.
   - واجهات React (Forms, Dashboards, Wizards).
4. **اختبارات + توثيق**:
   - وحدات service.
   - سيناريو إجازة → حضور → راتب.
   - تحديث أدلة النشر.
5. **تشغيل الخدمات الذكية**:
   - جدولة Cron.
   - تكامل Gemini.
   - عرض التنبيهات والتحليلات.

## 6. ملاحظات إضافية
- جميع الخدمات يجب أن تكون متعددة المؤسسات (`org_id`).
- يجب دعم اللغتين (ar/en) لكل النصوص الجديدة (التنبيهات، التحليلات).
- إمكانية إضافة ورديات مستقبلية عبر جدول `hr_shifts` إن تطلب الأمر، لكن البداية ستكون بقيم ثابتة وفق السياسات أعلاه.

---

تمثل هذه الوثيقة مرجع التنفيذ التفصيلي قبل البدء في كتابة الشيفرة. أي تحديث بالمتطلبات سيتم توثيقه هنا ليتوافق مع «حاسبني».


