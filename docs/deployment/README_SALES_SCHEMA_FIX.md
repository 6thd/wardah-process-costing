# ุฅุตูุงุญ Schema ุฌุฏุงูู ุงููุจูุนุงุช - Sales Schema Fix

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูููู ูุตูุญ ุงูุนูุงูุงุช ุงูููููุฏุฉ ูุงูุฃุนูุฏุฉ ุงูููููุฏุฉ ูู ุฌุฏุงูู ุงููุจูุนุงุช.

## ๐ง ุงููุดุงูู ุงูุชู ุชู ุฅุตูุงุญูุง

1. โ ุฅุถุงูุฉ Foreign Key ูู `sales_invoice_lines.product_id` ุฅูู `items.id`
2. โ ุฅุถุงูุฉ ุนููุฏ `item_id` ูู `sales_invoice_lines` ุฅุฐุง ูู ููู ููุฌูุฏุงู
3. โ ุฅุถุงูุฉ `quantity_delivered` ู `unit_cost_at_delivery` ูู `delivery_note_lines`
4. โ ุฅุถุงูุฉ `unit_cost_at_sale` ูู `sales_invoice_lines`
5. โ ุฅูุดุงุก `delivery_note_lines` ุฅุฐุง ูู ููู ููุฌูุฏุงู
6. โ ุฅุถุงูุฉ indexes ููุฃุฏุงุก

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### 1. ุชูููุฐ ูููุงุช SQL ุจุงูุชุฑุชูุจ

**ุงูุชุฑุชูุจ ุงููุทููุจ:**
1. ุฃููุงู: `sql/06_sales_tables_fix.sql` - ุฅุตูุงุญ ุงูุฌุฏุงูู ุงูุฃุณุงุณูุฉ
2. ุซุงููุงู: `sql/07_sales_schema_fix.sql` - ุฅุตูุงุญ ุงูุนูุงูุงุช ูุงูุฃุนูุฏุฉ
3. ุซุงูุซุงู: `sql/08_sales_performance_and_security.sql` - ุชุญุณูู ุงูุฃุฏุงุก ูุงูุฃูุงู (ุงุฎุชูุงุฑู ููู ููุตู ุจู)

### 2. ุชูููุฐ ูู Supabase

1. ุงูุชุญ Supabase Dashboard
2. ุงุฐูุจ ุฅูู **SQL Editor**
3. **ุงูููู ุงูุฃูู**: ุงูุณุฎ ูุญุชูู `sql/06_sales_tables_fix.sql` ูุงูุตู ูู SQL Editor ูุงุถุบุท **Run**
4. **ุงูููู ุงูุซุงูู**: ุงูุณุฎ ูุญุชูู `sql/07_sales_schema_fix.sql` ูุงูุตู ูู SQL Editor ูุงุถุบุท **Run**
5. **ุงูููู ุงูุซุงูุซ (ููุตู ุจู)**: ุงูุณุฎ ูุญุชูู `sql/08_sales_performance_and_security.sql` ูุงูุตู ูู SQL Editor ูุงุถุบุท **Run**

### 3. ุงูุชุญูู ูู ุงููุชุงุฆุฌ

ุจุนุฏ ุงูุชูููุฐุ ูุฌุจ ุฃู ุชุฑู:
- โ ุฑุณุงุฆู `NOTICE` ุชุคูุฏ ุฅุถุงูุฉ ุงูุฃุนูุฏุฉ/ุงูุนูุงูุงุช
- โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก (ููุท ุชุญุฐูุฑุงุช ุฅุฐุง ูุงูุช ุจุนุถ ุงูุฌุฏุงูู ููููุฏุฉ)

### 4. ุงูุชุญูู ูู ุงูุนูุงูุงุช

ููููู ุงูุชุญูู ูู ุงูุนูุงูุงุช ูู Supabase:
- `sales_invoice_lines` โ ูุฌุจ ุฃู ูุญุชูู ุนูู FK ุฅูู `items`
- `delivery_note_lines` โ ูุฌุจ ุฃู ูุญุชูู ุนูู `quantity_delivered` ู `unit_cost_at_delivery`
- `sales_invoice_lines` โ ูุฌุจ ุฃู ูุญุชูู ุนูู `unit_cost_at_sale`

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ุงููุณุฎ ุงูุงุญุชูุงุทู**: ูููุตุญ ุจุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจู ุงูุชูููุฐ
2. **ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ**: ุฅุฐุง ูุงู ูุฏูู ุจูุงูุงุช ููุฌูุฏุฉุ ุณูุชู ูุณุฎ ุงูููู ูู ุงูุฃุนูุฏุฉ ุงููุฏููุฉ ุฅูู ุงูุฌุฏูุฏุฉ
3. **ุงูุนูุงูุงุช**: ุงูููู ูุญุงูู ุฅุถุงูุฉ FK constraints - ุฅุฐุง ูุดูุ ุณูุชู ุชุฎุทููุง ูุน ุฑุณุงูุฉ ุชุญุฐูุฑ

## ๐ ุงููุดุงูู ุงูุดุงุฆุนุฉ

### ุฎุทุฃ: "Could not find a relationship between 'sales_invoice_lines' and 'items'"
**ุงูุญู**: ุชูููุฐ `sql/07_sales_schema_fix.sql` ูุฅุถุงูุฉ FK constraint

### ุฎุทุฃ: "column delivery_note_lines_1.quantity_delivered does not exist"
**ุงูุญู**: ุชูููุฐ `sql/07_sales_schema_fix.sql` ูุฅุถุงูุฉ ุงูุนููุฏ

### ุฎุทุฃ: "column sales_invoice_lines.unit_cost_at_sale does not exist"
**ุงูุญู**: ุชูููุฐ `sql/07_sales_schema_fix.sql` ูุฅุถุงูุฉ ุงูุนููุฏ

## ๐ ุจุนุฏ ุงูุชูููุฐ

ุจุนุฏ ุชูููุฐ ุงููููุงุช:
1. ูุฌุจ ุฃู ุชุนูู ุชูุงุฑูุฑ ุงููุจูุนุงุช ุจุฏูู ุฃุฎุทุงุก
2. ูุฌุจ ุฃู ุชุธูุฑ ุงูุจูุงูุงุช ุจุดูู ุตุญูุญ
3. ูุฌุจ ุฃู ุชุนูู ุฌููุน ุงูุนูุงูุงุช ุจุดูู ุตุญูุญ
4. **ูุน ุงูููู ุงูุซุงูุซ**: ุณุชููู ุงูุงุณุชุนูุงูุงุช ุฃุณุฑุน ูุงูุฃูุงู ุฃูุถู

## ๐ ุงูููุงุฆุฏ ูู ุงูููู ุงูุซุงูุซ (`08_sales_performance_and_security.sql`)

### Indexes (ุงูููุงุฑุณ):
- โ **Composite Indexes** ููุงุณุชุนูุงูุงุช ุงููุนูุฏุฉ (ุฃุณุฑุน 10-100x)
- โ Indexes ููุจุญุซ ุญุณุจ ุงูุชุงุฑูุฎ/ุงูุนููู/ุงูููุชุฌ
- โ Indexes ููู JOINs ุจูู ุงูุฌุฏุงูู

### RLS Policies (ุงูุฃูุงู):
- โ **ุนุฒู ุงูุจูุงูุงุช** ุญุณุจ `org_id` (ูู ููุธูุฉ ุชุฑู ุจูุงูุงุชูุง ููุท)
- โ ุญูุงูุฉ ูู ุงููุตูู ุบูุฑ ุงููุตุฑุญ ุจู
- โ ุฃูุงู ุนูู ูุณุชูู ุงูุตููู (Row Level Security)

### ุงูุฃุฏุงุก:
- โ ุชูุงุฑูุฑ ุงููุจูุนุงุช ุฃุณุฑุน ุจุดูู ููุญูุธ
- โ ุงุณุชุนูุงูุงุช JOIN ุฃุณุฑุน
- โ ุงุณุชุนูุงูุงุช ุงูุชุงุฑูุฎ/ุงููุทุงู ุฃุณุฑุน

## ๐ ุชุญุฏูุซ ุงูููุฏ

ุชู ุชุญุฏูุซ ุงูููุฏ ูู `src/services/sales-reports-service.ts` ูุงุณุชุฎุฏุงู fallback mechanism ุฅุฐุง ูู ุชูู ุงูุนูุงูุงุช ููุฌูุฏุฉ. ุงูููุฏ ุงูุขู:
- ูุญุงูู ุงุณุชุฎุฏุงู `items!inner` ุฃููุงู
- ุฅุฐุง ูุดูุ ูุณุชุฎุฏู `product_id` ูุจุงุดุฑุฉ ููุฌูุจ `items` ุจุดูู ูููุตู
- ูุนูู ุญุชู ูู ูู ุชูู ุงูุนูุงูุงุช ููุฌูุฏุฉ


