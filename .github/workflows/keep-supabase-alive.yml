name: Keep Supabase Database Active

on:
  # ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø£ÙŠØ§Ù…
  schedule:
    - cron: '0 12 */5 * *'  # ÙƒÙ„ 5 Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø§Ø¹Ø© 12 Ø¸Ù‡Ø±Ø§Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª UTC
  
  # ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† GitHub
  workflow_dispatch:

jobs:
  ping-database:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: "https://uutfztmqvajmsxnrqeiv.supabase.co"
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ping Supabase - Check Journals
        run: |
          echo "ğŸ”„ Sending query to Supabase to keep database active..."
          
          # Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø­Ù‚ÙŠÙ‚ÙŠ: Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ§ØªØ±
          response=$(curl -s -w "\n%{http_code}" \
            -X GET "$SUPABASE_URL/rest/v1/journals?select=count" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“Š HTTP Status: $http_code"
          echo "ğŸ“ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Database is active and responding!"
          else
            echo "âš ï¸ Warning: Unexpected response code: $http_code"
            exit 1
          fi

      - name: Ping Supabase - Check Accounts
        run: |
          echo "ğŸ”„ Checking GL Accounts table..."
          
          # Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø«Ø§Ù†ÙŠ: Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
          response=$(curl -s -w "\n%{http_code}" \
            -X GET "$SUPABASE_URL/rest/v1/gl_accounts?select=count&limit=1" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“Š HTTP Status: $http_code"
          echo "ğŸ“ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… GL Accounts table is accessible!"
          else
            echo "âš ï¸ Warning: Could not access GL Accounts"
          fi

      - name: Ping Supabase - Test Function
        run: |
          echo "ğŸ”„ Testing trial balance function..."
          
          # Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø«Ø§Ù„Ø«: ØªØ´ØºÙŠÙ„ Ø¯Ø§Ù„Ø© Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
          response=$(curl -s -w "\n%{http_code}" \
            -X POST "$SUPABASE_URL/rest/v1/rpc/rpc_get_trial_balance" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "p_tenant": "00000000-0000-0000-0000-000000000001",
              "p_as_of_date": "2025-12-31"
            }')
          
          http_code=$(echo "$response" | tail -n1)
          
          echo "ğŸ“Š HTTP Status: $http_code"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Trial balance function executed successfully!"
          else
            echo "âš ï¸ Warning: Function execution returned: $http_code"
          fi

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Keep-Alive Job Completed Successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“… Timestamp: $(date)"
          echo "âœ… Database connection verified"
          echo "âœ… Multiple queries executed"
          echo "âœ… Supabase project should remain active"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
