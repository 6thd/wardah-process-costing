# نظام القيود المحاسبية الكامل
# Complete Accounting Journal Entry System

## تم إنجازه ✅

### 1. قيود اليومية (Journal Entries)
**الموقع:** `src/features/accounting/journal-entries/index.tsx`

**المميزات:**
- ✅ إضافة قيود جديدة مع بنود متعددة
- ✅ تعديل القيود (المسودة فقط)
- ✅ حذف القيود (المسودة فقط)
- ✅ ترحيل القيود (Posting)
- ✅ عرض جميع القيود مع الفلترة
- ✅ التحقق من التوازن تلقائياً (Debit = Credit)
- ✅ دعم الحسابات من شجرة الحسابات
- ✅ دعم أنواع الدفاتر المختلفة (عام، مبيعات، مشتريات، نقدية، بنك)
- ✅ وصف ثنائي اللغة (عربي/إنجليزي)
- ✅ المراجع الخارجية (Reference Type & Number)

**الحالات:**
- `draft` - مسودة (قابلة للتعديل والحذف)
- `posted` - مرحّل (للعرض فقط)
- `reversed` - معكوس

### 2. ميزان المراجعة (Trial Balance)
**الموقع:** `src/features/accounting/trial-balance/index.tsx`

**المميزات:**
- ✅ عرض الأرصدة الافتتاحية (Opening Balance)
- ✅ عرض حركة الفترة (Period Movement)
- ✅ عرض الأرصدة الختامية (Closing Balance)
- ✅ حساب الإجماليات تلقائياً
- ✅ التحقق من التوازن (Balanced Check)
- ✅ فلترة حسب نوع الحساب (Assets, Liabilities, etc.)
- ✅ فلترة حسب الفترة الزمنية
- ✅ تصدير إلى Excel
- ✅ تصدير إلى PDF
- ✅ عرض ثنائي اللغة

**الأعمدة:**
- كود الحساب + اسم الحساب
- رصيد افتتاحي (مدين/دائن)
- حركة الفترة (مدين/دائن)
- رصيد ختامي (مدين/دائن)

### 3. قاعدة البيانات
**الملف:** `setup-accounting-system.sql`

**الجداول:**
- `journals` - الدفاتر (7 دفاتر افتراضية)
- `journal_entries` - القيود
- `journal_lines` - بنود القيود
- `accounts` - الحسابات (موجود مسبقاً)

**الدوال:**
- `generate_entry_number(p_journal_id)` - توليد رقم القيد تلقائياً
- `post_journal_entry(p_entry_id)` - ترحيل القيد
- `rpc_get_trial_balance(p_tenant, p_as_of_date)` - جلب ميزان المراجعة

**القيود (Constraints):**
- التوازن: `total_debit = total_credit`
- كل بند إما مدين أو دائن: `(debit > 0 AND credit = 0) OR (debit = 0 AND credit > 0)`
- عدم الترحيل للحسابات الرئيسية: `is_leaf = true`

### 4. المسارات (Routes)
- `/accounting/journal-entries` - قيود اليومية
- `/accounting/trial-balance` - ميزان المراجعة

تم إضافتها إلى:
- `src/pages/routes.tsx` (Lazy Loading)
- `src/components/layout/sidebar.tsx` (القائمة الجانبية)

## التعليمات

### 1. إعداد قاعدة البيانات
```sql
-- في Supabase SQL Editor
-- نفّذ الملف: setup-accounting-system.sql
```

سيتم:
- ✅ إنشاء الجداول اللازمة
- ✅ إنشاء الدوال (Functions)
- ✅ إنشاء 7 دفاتر افتراضية
- ✅ إنشاء الفهارس (Indexes)

### 2. استخدام قيود اليومية

#### إضافة قيد جديد:
1. اختر نوع الدفتر (Journal Type)
2. أدخل التاريخ والوصف
3. أضف بنود القيد:
   - اختر الحساب
   - أدخل المبلغ (مدين أو دائن فقط)
   - أضف وصف البند (اختياري)
4. تأكد من التوازن (✓ متوازن)
5. احفظ القيد (يصبح مسودة)

#### ترحيل القيد:
1. افتح القيد المطلوب
2. راجع التفاصيل
3. اضغط على زر "ترحيل" (✓)
4. بعد الترحيل:
   - يصبح غير قابل للتعديل
   - يُدرج في ميزان المراجعة
   - يحدث الأرصدة

### 3. استخدام ميزان المراجعة

#### عرض الأرصدة:
1. اختر "من تاريخ" و "إلى تاريخ"
2. اختر نوع الحساب (اختياري)
3. اضغط "تحديث"

#### التصدير:
- **Excel:** لكل التفاصيل مع الصيغ
- **PDF:** للطباعة والأرشفة

#### التحقق من التوازن:
- ✅ رسالة خضراء: متوازن
- ❌ رسالة حمراء: غير متوازن (راجع القيود)

## منطق المحاسبة

### قواعد التوازن:
```
إجمالي المدين = إجمالي الدائن
Total Debit = Total Credit
```

### أنواع الحسابات:
- **Assets (أصول):** رصيد مدين طبيعي
- **Liabilities (التزامات):** رصيد دائن طبيعي
- **Equity (حقوق الملكية):** رصيد دائن طبيعي
- **Revenue (إيرادات):** رصيد دائن طبيعي
- **Expense (مصروفات):** رصيد مدين طبيعي

### حساب الأرصدة:
```typescript
// رصيد افتتاحي = الحركات قبل تاريخ البداية
opening_balance = movements before from_date

// حركة الفترة = الحركات في الفترة المحددة
period_movement = movements between from_date and as_of_date

// رصيد ختامي = افتتاحي + حركة الفترة
closing_balance = opening_balance + period_movement

// إذا كان مدين > دائن
if (debit > credit) {
  balance_debit = debit - credit
  balance_credit = 0
}
// إذا كان دائن > مدين
else {
  balance_debit = 0
  balance_credit = credit - debit
}
```

## أمثلة عملية

### مثال 1: قيد شراء نقدي
```
الوصف: شراء مواد خام LDPE نقداً
التاريخ: 2024-01-15

مدين:
  131100 - مواد خام LDPE        50,000.00

دائن:
  110101 - صندوق الرياض         50,000.00
```

### مثال 2: قيد رواتب
```
الوصف: رواتب شهر يناير 2024
التاريخ: 2024-01-31

مدين:
  620100 - رواتب إدارية        30,000.00

دائن:
  210201 - رواتب مستحقة        27,000.00
  210203 - تأمينات اجتماعية      3,000.00
```

## الحماية والأمان

### القيود المرحّلة:
- ❌ لا يمكن تعديلها
- ❌ لا يمكن حذفها
- ✅ يمكن عرضها فقط
- ✅ يمكن عكسها (Reverse) بقيد جديد

### التحقق التلقائي:
- التوازن قبل الحفظ
- التوازن قبل الترحيل
- عدم الترحيل للحسابات الرئيسية
- عدم السماح بمدين ودائن معاً

## الدعم الثنائي اللغة

جميع العناصر تدعم:
- ✅ العربية (اتجاه من اليمين لليسار)
- ✅ الإنجليزية (اتجاه من اليسار لليمين)

تبديل تلقائي حسب لغة النظام.

## الحالة الحالية

✅ **جاهز للاستخدام!**

- واجهات كاملة ومتكاملة
- منطق محاسبي صحيح
- دعم ثنائي اللغة
- تصدير Excel & PDF
- تحقق تلقائي من التوازن

## الخطوات التالية (اختياري)

1. **تقارير إضافية:**
   - دفتر الأستاذ (General Ledger)
   - كشف حساب (Account Statement)
   - القيود الإحصائية (Statistics)

2. **ميزات متقدمة:**
   - الموافقات (Approvals Workflow)
   - المرفقات (Attachments)
   - التعليقات (Comments/Notes)
   - تاريخ التعديلات (Audit Trail)

3. **التكامل:**
   - ربط تلقائي مع المشتريات
   - ربط تلقائي مع المبيعات
   - ربط تلقائي مع المخازن
   - ربط تلقائي مع الرواتب
