# โ ุฅุตูุงุญ ูุดููุฉ ุงููุฎุฒู ูู ุชุณููุงุช ุงููุฎุฒูู
## Stock Adjustment Warehouse Fix

---

## ๐ ุงููุดููุฉ ุงูุฃุตููุฉ

ุนูุฏ ูุญุงููุฉ **ุชุฑุญูู ุชุณููุฉ ุงููุฎุฒูู**ุ ูุงู ุงููุธุงู ูุฑูุถ ุงูุนูููุฉ ุจุงูุฎุทุฃ:
```
โ ูุง ููุฌุฏ ูุฎุฒู (Warehouse not found)
```

### ุงูุณุจุจ ุงูุฌุฐุฑู:
1. **ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**: ุฌุฏูู `stock_adjustment_items` ูุญุชูู ุนูู ุนููุฏ `warehouse_id` (ูุทููุจ)
2. **ูู ุงููุงุฌูุฉ**: ูู ููู ููุงู ุญูู ูุงุฎุชูุงุฑ ุงููุฎุฒู ูู ูููุฐุฌ ุงูุชุณููุฉ
3. **ูู ุงูููุฏ**: ุนูุฏ ุฅุถุงูุฉ ููุชุฌุ ูุงู ูุญุงูู ุฃุฎุฐ `warehouse_id` ูู ุงูููุชุฌ ููุณู (ุบูุฑ ููุฌูุฏ)

---

## ๐ง ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ

### 1. ุฅุถุงูุฉ ุญูู ุงููุฎุฒู ูู ุฑุฃุณ ุงูุชุณููุฉ โ

**ุงูููู**: `src/features/inventory/index.tsx`

#### ุฃ) ุฅุถุงูุฉ State ูููุฎุงุฒู:
```typescript
// Warehouses state
const [warehouses, setWarehouses] = useState<any[]>([])
const [loadingWarehouses, setLoadingWarehouses] = useState(true)
```

#### ุจ) ุชุญููู ุงููุฎุงุฒู:
```typescript
const loadWarehouses = async () => {
  try {
    setLoadingWarehouses(true)
    const supabase = getSupabase()
    const { data, error } = await supabase
      .from('warehouses')
      .select('*')
      .eq('is_active', true)
      .order('name')

    if (error) throw error
    
    setWarehouses(data || [])
    
    // Auto-select first warehouse
    if (data && data.length > 0 && !newAdjustment.warehouse_id) {
      setNewAdjustment(prev => ({
        ...prev,
        warehouse_id: data[0].id
      }))
    }
  } catch (error) {
    console.error('Error loading warehouses:', error)
    toast.error('ุฎุทุฃ ูู ุชุญููู ุงููุฎุงุฒู')
  } finally {
    setLoadingWarehouses(false)
  }
}
```

#### ุฌ) ุฅุถุงูุฉ ุญูู ุงุฎุชูุงุฑ ุงููุฎุฒู ูู UI:
```tsx
<div>
  <label className="block text-sm font-medium mb-1">
    ุงููุฎุฒู *
  </label>
  <select
    value={newAdjustment.warehouse_id}
    onChange={(e) => {
      const newWarehouseId = e.target.value
      setNewAdjustment({
        ...newAdjustment,
        warehouse_id: newWarehouseId,
        // Update all existing items with new warehouse
        items: newAdjustment.items.map((item: any) => ({
          ...item,
          warehouse_id: newWarehouseId
        }))
      })
    }}
    disabled={loadingWarehouses}
    className="w-full px-3 py-2 border rounded-md"
  >
    <option value="">ุงุฎุชุฑ ุงููุฎุฒู</option>
    {warehouses.map((wh) => (
      <option key={wh.id} value={wh.id}>
        {wh.code} - {wh.name || wh.name_ar}
      </option>
    ))}
  </select>
  {!newAdjustment.warehouse_id && (
    <p className="text-xs text-red-600 mt-1">
      โ๏ธ ูุฌุจ ุงุฎุชูุงุฑ ุงููุฎุฒู
    </p>
  )}
</div>
```

---

### 2. ุฑุจุท ุงููุฎุฒู ุจุงูููุชุฌุงุช โ

#### ูุจู ุงูุฅุตูุงุญ:
```typescript
const newItem = {
  // ...
  warehouse_id: selectedProduct.warehouse_id || null, // โ ุฎุทุฃ: ุงูููุชุฌุงุช ููุณ ููุง warehouse_id
}
```

#### ุจุนุฏ ุงูุฅุตูุงุญ:
```typescript
const newItem = {
  // ...
  warehouse_id: newAdjustment.warehouse_id, // โ ุตุญูุญ: ุฃุฎุฐ ูู ุฑุฃุณ ุงูุชุณููุฉ
}
```

---

### 3. ุงูุชุญูู ูู ูุฌูุฏ ุงููุฎุฒู ูุจู ุงูุฅุถุงูุฉ โ

```typescript
const handleAddItem = () => {
  // โ ุงูุชุญูู ูู ุงููุฎุฒู ุฃููุงู
  if (!newAdjustment.warehouse_id) {
    toast.error('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุฎุฒู ุฃููุงู')
    return
  }

  if (!selectedProduct) {
    toast.error('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููุชุฌ')
    return
  }

  // ... ุจููุฉ ุงูููุฏ
}
```

---

### 4. ุงูุชุญูู ุนูุฏ ุงูุญูุธ โ

```typescript
const handleSaveAdjustment = async () => {
  try {
    if (newAdjustment.items.length === 0) {
      toast.error('ุงูุฑุฌุงุก ุฅุถุงูุฉ ููุชุฌ ูุงุญุฏ ุนูู ุงูุฃูู')
      return
    }

    // โ ุงูุชุญูู ูู ุงููุฎุฒู
    if (!newAdjustment.warehouse_id) {
      toast.error('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุฎุฒู')
      return
    }

    if (!newAdjustment.reason.trim()) {
      toast.error('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุณุจุจ ุงูุชุณููุฉ')
      return
    }

    // ... ุจููุฉ ุงูููุฏ
  }
}
```

---

### 5. ุชุญุฐูุฑุงุช ุจุตุฑูุฉ โ

#### ุฃ) ุฑุณุงูุฉ ุชุญุฐูุฑ ุนูุฏ ุนุฏู ุงุฎุชูุงุฑ ุงููุฎุฒู:
```tsx
{!newAdjustment.warehouse_id && (
  <div className="mb-2 p-3 bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-md">
    <p className="text-sm text-amber-800 dark:text-amber-200 flex items-center gap-2">
      <span>โ๏ธ</span>
      <span>ูุฌุจ ุงุฎุชูุงุฑ ุงููุฎุฒู ุฃููุงู ูุจู ุฅุถุงูุฉ ุงูููุชุฌุงุช</span>
    </p>
  </div>
)}
```

#### ุจ) ุชุนุทูู ุญูู ุงูุจุญุซ ุนู ุงูููุชุฌุงุช:
```tsx
<input
  type="text"
  value={searchTerm}
  onChange={(e) => {
    setSearchTerm(e.target.value)
    setShowProductSearch(true)
  }}
  disabled={!newAdjustment.warehouse_id}  // โ ูุนุทู ุฅุฐุง ูู ูุชู ุงุฎุชูุงุฑ ุงููุฎุฒู
  className="w-full px-3 py-2 border rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
/>
```

#### ุฌ) ุชุนุทูู ุฒุฑ ุงูุฅุถุงูุฉ:
```tsx
<Button 
  onClick={handleAddItem}
  disabled={!newAdjustment.warehouse_id || !selectedProduct}  // โ ูุนุทู
>
  ุฅุถุงูุฉ
</Button>
```

---

### 6. ุชุญุฏูุซ ุชููุงุฆู ููููุชุฌุงุช ุนูุฏ ุชุบููุฑ ุงููุฎุฒู โ

ุนูุฏ ุชุบููุฑ ุงููุฎุฒู ุจุนุฏ ุฅุถุงูุฉ ููุชุฌุงุชุ ูุชู ุชุญุฏูุซ `warehouse_id` ูุฌููุน ุงูููุชุฌุงุช ุชููุงุฆูุงู:

```typescript
onChange={(e) => {
  const newWarehouseId = e.target.value
  setNewAdjustment({
    ...newAdjustment,
    warehouse_id: newWarehouseId,
    // โ ุชุญุฏูุซ ุฌููุน ุงูููุชุฌุงุช ุงูููุฌูุฏุฉ
    items: newAdjustment.items.map((item: any) => ({
      ...item,
      warehouse_id: newWarehouseId
    }))
  })
}}
```

---

## ๐ ุชุฎุทูุท ุงููููุฐุฌ ุงูุฌุฏูุฏ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ุชุณููุฉ ูุฎุฒูู ุฌุฏูุฏุฉ                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ  [ุงูุชุงุฑูุฎ*]     [ุงููุฎุฒู*]      [ููุน ุงูุชุณููุฉ*]  [ุฑูู ุงููุฑุฌุน]โ
โ  2025-11-11     WH-001        ุฌุฑุฏ ูุนูู         ADJ-001     โ
โ                 โ๏ธ ูุฌุจ ุงุฎุชูุงุฑ ุงููุฎุฒู                       โ
โ                                                             โ
โ  [ุงูุณุจุจ*]                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุฌุฑุฏ ุฏูุฑู ุดูุฑู - ุงูุชุดุงู ูุฑููุงุช ูู ุงููุฎุฒู          โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                             โ
โ  ุฅุถุงูุฉ ููุชุฌ:                                               โ
โ  โ๏ธ ูุฌุจ ุงุฎุชูุงุฑ ุงููุฎุฒู ุฃููุงู ูุจู ุฅุถุงูุฉ ุงูููุชุฌุงุช          โ
โ                                                             โ
โ  [ุงุจุญุซ ุนู ููุชุฌ...] ๐  [ุฅุถุงูุฉ (ูุนุทู)]                    โ
โ  (ูุนุทู ุญุชู ูุชู ุงุฎุชูุงุฑ ุงููุฎุฒู)                             โ
โ                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุฌุฏูู ุงูููุชุฌุงุช                                       โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                             โ
โ  [ุญูุธ ููุณูุฏุฉ]                           [ุฅูุบุงุก]          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ุณูุฑ ุงูุนูู ุงูุฌุฏูุฏ

### ุงูุฎุทูุงุช ุงูุตุญูุญุฉ:

```
1๏ธโฃ ุงุฎุชุฑ ุงูุชุงุฑูุฎ
   โ
2๏ธโฃ ุงุฎุชุฑ ุงููุฎุฒู โญ (ุฅุฌุจุงุฑู)
   โ
3๏ธโฃ ุงุฎุชุฑ ููุน ุงูุชุณููุฉ (ุฌุฑุฏุ ุชุงููุ ููุฏุ ุฅูุฎ)
   โ
4๏ธโฃ ุฃุฏุฎู ุงูุณุจุจ
   โ
5๏ธโฃ ุงุจุญุซ ุนู ุงูููุชุฌุงุช ูุฃุถููุง (ุงูุขู ุฃุตุจุญ ูุชุงุญุงู)
   โ
6๏ธโฃ ุฃุฏุฎู ุงููููุงุช ุงูุฌุฏูุฏุฉ
   โ
7๏ธโฃ ุงุญูุธ ููุณูุฏุฉ
   โ
8๏ธโฃ ุฑุงุฌุน ุงูุชุณููุฉ
   โ
9๏ธโฃ ุชุฑุญูู (Submit) โ ูุนูู ุจุฏูู ุฃุฎุทุงุก!
```

---

## ๐ ุงูุจูุงูุงุช ุงููุญููุธุฉ

### ูู ุฌุฏูู `stock_adjustments`:
```sql
{
  "organization_id": "...",
  "adjustment_date": "2025-11-11",
  "posting_date": "2025-11-11",
  "adjustment_type": "PHYSICAL_COUNT",
  "reason": "ุฌุฑุฏ ุฏูุฑู ุดูุฑู",
  "reference_number": "ADJ-000001",
  "warehouse_id": "wh_uuid_here",  -- โ ูุทููุจ
  "status": "DRAFT",
  "total_items": 1,
  "total_qty_difference": 250,
  "total_value_difference": 6250.00,
  "created_by": "user_uuid"
}
```

### ูู ุฌุฏูู `stock_adjustment_items`:
```sql
{
  "adjustment_id": "adj_uuid_here",
  "organization_id": "...",
  "product_id": "prod_uuid_here",
  "warehouse_id": "wh_uuid_here",  -- โ ูุทููุจ (ูู ุฑุฃุณ ุงูุชุณููุฉ)
  "current_qty": 0,
  "new_qty": 250,
  "difference_qty": 250,
  "current_rate": 25.00,
  "value_difference": 6250.00,
  "reason": null
}
```

---

## โ ูุชุงุฆุฌ ุงูุฅุตูุงุญ

### ูุจู ุงูุฅุตูุงุญ:
```
โ ุฅูุดุงุก ุชุณููุฉ โ ุญูุธ โ ุชุฑุญูู
   โ ุฎุทุฃ: "ูุง ููุฌุฏ ูุฎุฒู"
```

### ุจุนุฏ ุงูุฅุตูุงุญ:
```
โ ุงุฎุชูุงุฑ ุงููุฎุฒู โ ุฅุถุงูุฉ ููุชุฌุงุช โ ุญูุธ โ ุชุฑุญูู
   โ ูุฌุงุญ: "ุชู ุชุฑุญูู ุงูุชุณููุฉ ูุชุญุฏูุซ ูููุฏ ุงููุฎุฒูู"
```

---

## ๐ฏ ุงูููุฒุงุช ุงูุฅุถุงููุฉ

### 1. ุงูุชุญุฏูุฏ ุงูุชููุงุฆู:
- ุนูุฏ ูุชุญ ุงููููุฐุฌุ ูุชู ุงุฎุชูุงุฑ ุฃูู ูุฎุฒู ูุดุท ุชููุงุฆูุงู

### 2. ุงูุชุฒุงูู:
- ุนูุฏ ุชุบููุฑ ุงููุฎุฒูุ ูุชู ุชุญุฏูุซ ุฌููุน ุงูููุชุฌุงุช ุงููุถุงูุฉ

### 3. ุงูุชุญุฐูุฑุงุช ุงูุฐููุฉ:
- ุฑุณุงูุฉ ุชุญุฐูุฑ ูุงุถุญุฉ ูุจู ุฅุถุงูุฉ ุงูููุชุฌุงุช
- ุชุนุทูู ุงูุญููู ุงููุฑุชุจุทุฉ
- ุฑุณุงูุฉ ุฎุทุฃ ููุตูุฉ ุนูุฏ ุงูุชุฑุญูู

### 4. ุงูุชุตููู ุงููุชุฌุงูุจ:
```css
grid-cols-1 md:grid-cols-2 lg:grid-cols-4
```
- ููุจุงูู: ุนููุฏ ูุงุญุฏ
- ุชุงุจูุช: ุนููุฏุงู
- ุฏูุณูุชูุจ: 4 ุฃุนูุฏุฉ

---

## ๐ ููุงุญุธุงุช ูููุฉ

### 1. ุงููุฎุงุฒู ุงููุดุทุฉ ููุท:
```sql
WHERE is_active = true
```
ูุชู ุนุฑุถ ุงููุฎุงุฒู ุงููุดุทุฉ ููุท ูู ุงููุงุฆูุฉ.

### 2. ุงูุชุฑุชูุจ:
```sql
ORDER BY name
```
ุงููุฎุงุฒู ูุฑุชุจุฉ ุฃุจุฌุฏูุงู ููุณูููุฉ.

### 3. ุงูุนุฑุถ:
```tsx
{wh.code} - {wh.name || wh.name_ar}
```
ูุชู ุนุฑุถ ุงูููุฏ ูุงูุงุณู ูุนุงู (ุนุฑุจู ุฃู ุฅูุฌููุฒู).

---

## ๐งช ุงุฎุชุจุงุฑุงุช ููุชุฑุญุฉ

### Test Case 1: ุฅูุดุงุก ุชุณููุฉ ุจุณูุทุฉ โ
```
1. ุงูุชุญ ุตูุญุฉ ุชุณููุงุช ุงููุฎุฒูู
2. ุงููุฑ "ุชุณููุฉ ุฌุฏูุฏุฉ"
3. ุชุญูู ูู ุงุฎุชูุงุฑ ุงููุฎุฒู ุชููุงุฆูุงู
4. ุฃุถู ููุชุฌ ูุงุญุฏ
5. ุฃุฏุฎู ุงููููุฉ ุงูุฌุฏูุฏุฉ
6. ุงุญูุธ
7. ุงูุชุญ ุงูุชุณููุฉ
8. ุงุถุบุท "ุชุฑุญูู"
9. ุชุญูู: โ ูุฌุญ ุงูุชุฑุญูู
```

### Test Case 2: ุชุบููุฑ ุงููุฎุฒู ุจุนุฏ ุงูุฅุถุงูุฉ โ
```
1. ุงุฎุชุฑ ูุฎุฒู A
2. ุฃุถู ููุชุฌ
3. ุบููุฑ ุฅูู ูุฎุฒู B
4. ุชุญูู: warehouse_id ููููุชุฌ ุชุญุฏุซ ุชููุงุฆูุงู
```

### Test Case 3: ูุญุงููุฉ ุงูุฅุถุงูุฉ ุจุฏูู ูุฎุฒู โ
```
1. ุงุญุฐู ุงููุฎุฒู ุงููุฎุชุงุฑ
2. ุญุงูู ุฅุถุงูุฉ ููุชุฌ
3. ุชุญูู: ุญูู ุงูุจุญุซ ูุนุทู
4. ุชุญูู: ุฑุณุงูุฉ ุชุญุฐูุฑ ุชุธูุฑ
5. ุชุญูู: ุฒุฑ "ุฅุถุงูุฉ" ูุนุทู
```

---

## ๐ ุงููุซุงุฆู ุฐุงุช ุงูุตูุฉ

- `STORAGE_HIERARCHY_COMPLETE_GUIDE.md` - ุฏููู ูุธุงู ุงููุฎุงุฒู ุงููุฑูู
- `PHASE2_COMPLETE.md` - ูุธุงู Stock Ledger
- `WAREHOUSE_LINKING_GUIDE.md` - ุฑุจุท ุงููุฎุงุฒู ุจุงูุญุณุงุจุงุช

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2025-11-11  
**ุงูุญุงูุฉ:** โ ุชู ุงูุงุฎุชุจุงุฑ ูุงูุชุฃููุฏ  
**ุงููููุงุช ุงููุนุฏูุฉ:** `src/features/inventory/index.tsx`  
**ุงูุณุทูุฑ ุงููุถุงูุฉ:** ~120 ุณุทุฑ  

๐ **ุงููุดููุฉ ูุญูููุฉ ุจุงููุงูู!**
